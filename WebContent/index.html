<html style="height:100%">
<head>
<title>Typhoon Tweet Tracker</title>
  <link rel="stylesheet" href="css/indexStyle.css">
  <script src="js/jquery.js"></script>
  <script src="js/sockjs-0.3.4.min.js"></script>
  <script src="js/vertxbus.js"></script>
</head>
<body style="height:100%">

  <div class="pull-left" style= "width:100%; height: 5%; background-color:black;">
    <form style="float:left" action="dashboard.jsp" method="GET">
      <strong style="color:#ecf0f1; margin: 10px"> Classify this tweet: </strong> <input type="text" name="tweet_id" placeholder="Tweet ID" autofocus>
      <input type="submit" value="Classify" />
    </form>
  </div>
  <div id = "content"style="width:100%; height:95%; background-color:#95a5a6">
  </div>

<script>
   function buildCategoryBoxes(msg){
    var categoryArray = msg;
    var contentHtml = "";

    for(var i=0; i<categoryArray.length; i++){
      var currCategory = categoryArray[i];
      contentHtml += ' <div class = "categoryBox"> <div class ="categoryBoxHeaderDiv"> <h2 class = "categoryBoxH2">'+currCategory.description+'</h2> </div> <div id ="'+currCategory.pk+'" class="categoryBoxBodyDiv">'; 

      var tweetsInCategory = currCategory.tweets;

      for(var j=0; j<tweetsInCategory.length; j++){
        var currTweet = tweetsInCategory[j];
        contentHtml += createElementForTweet(currTweet);
      }

      contentHtml +='</div></div>'; //close the categoryBoxBodyDiv and categoryBox
    }
    $('#content').html(contentHtml);
  }

  function addNewTweet(msg){
    console.log("went in add new tweet");
    console.log(msg);
    var tweetJson = msg;
    $('.'+tweetJson.category).append(createElementForTweet(tweetJson));
    console.log($('.'+tweetJson.category));
  }

  function createElementForTweet(tweet){
    return '<blockquote data-cards="hidden" height="10" class="twitter-tweet" lang="en"><p>'+tweet.text+'</p><a href= <%='+tweet.link+'%>></a></blockquote><script async src="js/widgets.js" charset="utf-8"><\/script>';
  }

  var eb = null;
  var SERVER_REQUEST_INITIAL_CATEGORIES = "requestTweets";
  var RECEIVE_NEW_TWEETS_ADDRESS = "newTweets";
  openConn();

  function closeConn() {
    if (eb) {
      eb.close();
    }
  }

  function openConn() {
    if (!eb) {
      eb = new vertx.EventBus("http://localhost:8080/eventbus");

      eb.onopen = function() {
        eb.send(SERVER_REQUEST_INITIAL_CATEGORIES, {}, buildCategoryBoxes);
        //execute this once the category boxes have been built
        eb.registerHandler(RECEIVE_NEW_TWEETS_ADDRESS, addNewTweet);
      };

      eb.onclose = function() {
        eb = null;
      };
    }
  }

  function generateUserID(){
    return ""+Math.random()+Math.random();
  }


  </script>
</body>
</html>

  
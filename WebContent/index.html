<html style="height:100%">
<head>
  <title>Typhoon Tweet Tracker</title>
  <link rel="stylesheet" href="css/indexStyle.css">
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <script src="js/jquery.js"></script>
  <script src="js/sockjs-0.3.4.min.js"></script>
  <script src="js/vertxbus.js"></script>
</head>
<body style="height:100%">
  <div class = "container-fluid" style="height=100%" >
    <div class="span12" style= "width:100%; height: 5%; background-color:black; float:left; display:block;">
      <form style="float:left" action="dashboard.jsp" method="GET">
        <strong style="color:#ecf0f1; margin: 10px"> Classify this tweet: </strong> <input type="text" name="tweet_id" placeholder="Tweet ID" autofocus>
        <input type="submit" value="Classify" />
      </form>
    </div>
    
    <div id = "content" class = "container-fluid" style="width:100%; height:95%; background-color:#95a5a6">
      <div class = "span12" id = "firstRow">
      </div>

      <div class = "span12" id = "secondRow">
      </div>
    </div>
  </div>



<script>
 function buildCategoryBoxes(msg){
  var categoryArray = msg;
  var contentHtml = '';

  if(categoryArray.length > 0){


    for(var i=0; i<categoryArray.length; i++){
      if(i%3 == 0){
        if(i > 0)
          contentHtml += '</div>';
        contentHtml += '<div class = "row">';
      }


      var currCategory = categoryArray[i];
      contentHtml += '<div class="panel panel-primary span4 categoryBox" id ="'+currCategory.pk+'">\
      <div class="panel-heading">'+currCategory.description+'</div>\
      <div class="panel-body">\
        ';

        var tweetsInCategory = currCategory.tweets;

        for(var j=0; j<tweetsInCategory.length; j++){
          var currTweet = tweetsInCategory[j];
          contentHtml += createElementForTweet(currTweet);
        }


        contentHtml +='</div></div>'; //close the categoryBoxBodyDiv and categoryBox

        
      }
      $('#content').html(contentHtml);
    }
  }

  function addNewTweet(msg){
    console.log("went in add new tweet");
    console.log(msg);
    var tweetJson = msg;
    $('#'+tweetJson.category+".panel-body").prepend(createElementForTweet(tweetJson));
  }

  function createElementForTweet(tweet){

    return '<blockquote data-cards="hidden" height="10" class="twitter-tweet" lang="en"><p>'+tweet.text+'</p><a href= <%='+tweet.link+'%>></a></blockquote><script async src="js/widgets.js" charset="utf-8"><\/script>';
  }

  var eb = null;
  var SERVER_REQUEST_INITIAL_CATEGORIES = "requestTweets";
  var RECEIVE_NEW_TWEETS_ADDRESS = "newTweets";
  openConn();

  function closeConn() {
    if (eb) {
      eb.close();
    }
  }

  function openConn() {
    if (!eb) {
      eb = new vertx.EventBus("http://localhost:8080/eventbus");

      eb.onopen = function() {
        eb.send(SERVER_REQUEST_INITIAL_CATEGORIES, {}, buildCategoryBoxes);
        //execute this once the category boxes have been built
        eb.registerHandler(RECEIVE_NEW_TWEETS_ADDRESS, addNewTweet);
      };

      eb.onclose = function() {
        eb = null;
      };
    }
  }

  function generateUserID(){
    return ""+Math.random()+Math.random();
  }


</script>
</body>
</html>

